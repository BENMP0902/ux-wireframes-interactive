# üìã FLOWS.md - Documentaci√≥n T√©cnica de Flujos de Usuario

> Especificaci√≥n completa de los tres flujos implementados en el proyecto de wireframes interactivos.

---

## üìö √çndice

1. [Introducci√≥n](#introducci√≥n)
2. [Opci√≥n A: Solicitud de Cita M√©dica](#opci√≥n-a-solicitud-de-cita-m√©dica)
3. [Opci√≥n B: Actualizaci√≥n de Direcci√≥n](#opci√≥n-b-actualizaci√≥n-de-direcci√≥n)
4. [Opci√≥n C: Generaci√≥n de Factura](#opci√≥n-c-generaci√≥n-de-factura)
5. [Matriz de Validaciones](#matriz-de-validaciones)
6. [Patrones de Dise√±o](#patrones-de-dise√±o)

---

## üéØ Introducci√≥n

Este documento detalla la l√≥gica de negocio, validaciones y flujos de error para los tres casos de uso implementados. Cada flujo contiene **6 pasos** documentados exhaustivamente.

### Prop√≥sito del Documento

- ‚úÖ Gu√≠a de implementaci√≥n para desarrolladores
- ‚úÖ Referencia de validaciones y reglas de negocio
- ‚úÖ Cat√°logo de mensajes de error y retroalimentaci√≥n
- ‚úÖ Documentaci√≥n de decisiones de flujo

### Convenciones

| Elemento | Descripci√≥n |
|----------|-------------|
| **Campo obligatorio** | Marcado con `*` |
| `c√≥digo` | Nombres de variables/funciones |
| [Bot√≥n] | Elementos interactivos |
| ‚Üí | Flujo de navegaci√≥n |

---

## üè• OPCI√ìN A: Solicitud de Cita M√©dica

### Resumen del Flujo

**Objetivo**: Permitir al usuario agendar una cita m√©dica de forma r√°pida y sin ambig√ºedades.

**Pasos**: 6  
**Tiempo estimado**: 3-5 minutos  
**Complejidad**: Media

**Diagrama de flujo simplificado:**
```
Login ‚Üí Especialidad ‚Üí M√©dico/Fecha ‚Üí Horario ‚Üí Motivo ‚Üí Confirmaci√≥n
```

---

### üìç Paso 1: Autenticaci√≥n

**Campos**:
- Email/Usuario *
- Contrase√±a *
- [Checkbox] Recordar sesi√≥n

**Validaciones**:
- Email: formato v√°lido (@dominio.extensi√≥n)
- Contrase√±a: m√≠nimo 8 caracteres
- L√≠mite: 3 intentos fallidos ‚Üí bloqueo 15 min

**Errores**:
- "Usuario o contrase√±a incorrectos. Te quedan X intentos"
- "Tu cuenta ha sido temporalmente bloqueada por seguridad. Intenta en 15 minutos"
- "Este campo es obligatorio"

**Decisi√≥n**: ¬øUsuario autenticado? ‚Üí S√≠: Paso 2 | No: Registro

---

### üìç Paso 2: Selecci√≥n de Especialidad

**Elementos**:
- Buscador con autocompletado
- Lista categorizada de especialidades
- Filtros: "Solo disponibles hoy", "Alfab√©tico"

**Validaciones**:
- Selecci√≥n √∫nica (1 especialidad)
- Verificar disponibilidad en 30 d√≠as
- B√∫squeda m√≠nimo 2 caracteres

**Errores**:
- "Lo sentimos, no hay citas disponibles para Cardiolog√≠a en los pr√≥ximos 30 d√≠as. Puedes agregarte a la lista de espera"
- "No encontramos esa especialidad. ¬øQuisiste decir...?"
- "No pudimos cargar las especialidades. Verifica tu conexi√≥n" + [Reintentar]

**Decisi√≥n**: ¬øDisponibilidad? ‚Üí S√≠: Paso 3 | No: Lista de espera

---

### üìç Paso 3: M√©dico y Fecha

**Elementos**:
- Tarjetas de m√©dicos (foto, nombre, rating, rese√±as)
- Opci√≥n "Primer m√©dico disponible"
- Calendario 30 d√≠as con c√≥digo de colores:
  - üü¢ Verde: 5+ horarios
  - üü° Amarillo: 2-4 horarios
  - üî¥ Rojo: 1 horario
  - ‚ö™ Gris: Sin disponibilidad

**Validaciones**:
- Solo fechas futuras
- M√°ximo 30 d√≠as desde hoy
- Si m√©dico espec√≠fico ‚Üí filtrar calendario

**Errores**:
- "No puedes seleccionar fechas pasadas. Elige desde hoy en adelante"
- "Dr. Garc√≠a no tiene citas disponibles en los pr√≥ximos 30 d√≠as. ¬øDeseas ver otros m√©dicos?"
- "No pudimos cargar las fechas disponibles" + [Reintentar]

**Decisi√≥n**: M√©dico primero ‚Üí Filtra calendario | Fecha primero ‚Üí Muestra m√©dicos disponibles

---

### üìç Paso 4: Selecci√≥n de Horario

**Elementos**:
- Horarios agrupados (Ma√±ana/Tarde/Noche)
- Cada horario: hora, duraci√≥n, m√©dico, ubicaci√≥n
- Indicador "M√°s solicitado"
- Tipo: Presencial / Telemedicina

**Validaciones**:
- Selecci√≥n √∫nica
- Verificaci√≥n en tiempo real
- Bloqueo temporal 5 minutos

**Errores**:
- "Este horario acaba de ser reservado por otro usuario. Por favor elige otro"
- "Todos los horarios se han ocupado para esta fecha. ¬øDeseas elegir otra fecha?"
- "Tu sesi√≥n ha expirado por inactividad. Inicia sesi√≥n nuevamente para continuar"

**Decisi√≥n**: ¬øDisponible? ‚Üí S√≠: Bloqueo + Paso 5 | No: Seleccionar otro

---

### üìç Paso 5: Motivo de Consulta

**Elementos**:
- Resumen no editable (con [Modificar])
- Textarea: Motivo * (10-500 caracteres)
- Contador de caracteres en tiempo real
- [Checkbox] ¬øPrimera vez con el m√©dico?
- [Checkbox] M√©todos de contacto (SMS/Email/WhatsApp)
- Info: Pol√≠ticas de cancelaci√≥n

**Validaciones**:
- Motivo: m√≠n 10, m√°x 500 caracteres
- Sin caracteres especiales: <, >, {, }
- Detecci√≥n de keywords de emergencia
- Al menos 1 m√©todo de contacto

**Errores**:
- "Por favor describe con m√°s detalle (m√≠nimo 10 caracteres). Esto ayudar√° al m√©dico a preparar mejor tu consulta"
- "No se permiten caracteres especiales como <, >, {, }"
- "‚ö†Ô∏è Detectamos que mencionas una emergencia. Si requieres atenci√≥n inmediata, llama al 911" + [Llamar] + [Continuar]

**Decisi√≥n**: ¬øEmergencia? ‚Üí S√≠: Banner + opciones | No: Paso 6

---

### üìç Paso 6: Confirmaci√≥n

**Elementos**:
- N√∫mero de cita: #CIT-YYYYMMDD-####
- Resumen completo (especialidad, m√©dico, fecha, hora, ubicaci√≥n, motivo)
- Costo y m√©todo de pago
- [Checkbox obligatorio] Acepto pol√≠ticas *
- [Confirmar cita] [Modificar] [Cancelar]
- Opciones post-confirmaci√≥n: Agregar a calendario

**Validaciones**:
- Checkbox pol√≠ticas debe estar marcado
- Verificaci√≥n final de disponibilidad
- Bloqueo temporal no expirado

**Errores**:
- "El tiempo para completar tu reserva ha expirado (5 min). El horario se liber√≥. ¬øDeseas intentar reservarlo nuevamente?"
- "Lo sentimos, otro usuario reserv√≥ este horario mientras completabas el proceso. Por favor selecciona otro horario"
- "Debes aceptar las pol√≠ticas de cancelaci√≥n para continuar"

**Flujo exitoso**:
1. Guarda en BD
2. Pantalla √©xito: "‚úì ¬°Tu cita ha sido confirmada!"
3. Env√≠o email PDF
4. Env√≠o SMS/WhatsApp
5. Opci√≥n descargar PDF
6. [Agregar a calendario]
7. [Ver todas mis citas]

**Post-acci√≥n autom√°tica**:
- Recordatorios: 24h antes + 2h antes
- Libera bloqueo temporal

---

## üì¶ OPCI√ìN B: Actualizaci√≥n de Direcci√≥n de Env√≠o

### Resumen del Flujo

**Objetivo**: Permitir al usuario gestionar direcciones de env√≠o con validaci√≥n geogr√°fica.

**Pasos**: 6  
**Tiempo estimado**: 2-4 minutos  
**Complejidad**: Media-Alta

---

### üìç Paso 1: Acceso a Configuraci√≥n

**Elementos**:
- Header con foto de perfil
- Men√∫: Informaci√≥n personal, Direcciones, M√©todos de pago, Seguridad
- Badge: "2 direcciones guardadas" o "‚ö†Ô∏è Agrega una direcci√≥n"

**Validaciones**:
- Sesi√≥n activa
- Tiempo de sesi√≥n > 5 min

**Errores**:
- "Tu sesi√≥n ha expirado por seguridad. Inicia sesi√≥n nuevamente"
- "No pudimos cargar tu informaci√≥n. Verifica tu conexi√≥n" + [Reintentar]

**Decisi√≥n**: Editar existente ‚Üí Carga datos | Nueva ‚Üí Formulario vac√≠o

---

### üìç Paso 2: Visualizaci√≥n de Direcciones

**Elementos**:
- Tarjetas por direcci√≥n:
  - Etiqueta (Casa, Trabajo, etc.)
  - Direcci√≥n resumida
  - Badge "Predeterminada"
  - [Editar] [Eliminar] [‚òÖ Predeterminada]
- [+ Agregar nueva direcci√≥n]
- Contador: "X/10 direcciones"

**Validaciones**:
- M√°ximo 10 direcciones
- M√≠nimo 1 direcci√≥n
- No eliminar predeterminada sin designar otra

**Errores**:
- "Has alcanzado el l√≠mite de 10 direcciones. Elimina una direcci√≥n para agregar una nueva"
- "Debes tener al menos una direcci√≥n guardada. Agrega otra antes de eliminar esta"
- "No puedes eliminar tu direcci√≥n predeterminada. Primero establece otra direcci√≥n como predeterminada"
- "Esta direcci√≥n est√° asociada a pedidos en proceso. ¬øEst√°s seguro de eliminarla?" + [Modal]

**Decisi√≥n**: Editar ‚Üí Paso 3 con datos | Nueva ‚Üí Paso 3 vac√≠o | Eliminar ‚Üí Modal | Predeterminada ‚Üí Actualizaci√≥n inmediata

---

### üìç Paso 3: Formulario de Direcci√≥n

**Campos**:
- Etiqueta * (Casa/Trabajo/Otro)
- Nombre de quien recibe *
- Tel√©fono * (+52 999 999 9999)
- C√≥digo Postal * (5 d√≠gitos) ‚Üí auto-completa Estado/Municipio
- Colonia * (dropdown seg√∫n CP)
- Calle *
- N√∫mero exterior *
- N√∫mero interior (opcional)
- Referencias (opcional, m√°x 200)
- [Checkbox] Direcci√≥n predeterminada
- [Usar ubicaci√≥n actual] (GPS)

**Validaciones en tiempo real**:
- CP: 5 d√≠gitos num√©ricos
- Tel√©fono: 10 d√≠gitos
- Calle: m√≠n 3, m√°x 100, sin n√∫meros al inicio
- N√∫m exterior: n√∫meros y letras (123-A)
- Referencias: m√°x 200 caracteres

**Errores**:
- "El c√≥digo postal ingresado no existe. Verifica e intenta nuevamente"
- "Lo sentimos, a√∫n no tenemos cobertura en este c√≥digo postal"
- "Ingresa un tel√©fono v√°lido de 10 d√≠gitos"
- "Este campo es obligatorio"
- "No pudimos detectar tu ubicaci√≥n. Verifica permisos de ubicaci√≥n en tu navegador"

**Decisi√≥n**: GPS ‚Üí Auto-completa | Manual ‚Üí Usuario completa

---

### üìç Paso 4: Validaci√≥n con Mapa

**Elementos**:
- Mapa interactivo (Google Maps)
- Pin movible en ubicaci√≥n detectada
- Direcci√≥n formateada arriba
- Controles zoom (+/-)
- [Ajustar manualmente]
- Panel lateral:
  - Coordenadas (lat, long)
  - Distancia a referencia
  - "‚úì Entregas en 24-48 hrs"
- Toggle: Vista sat√©lite/mapa

**Validaciones**:
- Coordenadas dentro de cobertura
- No en zona restringida
- Pin en ubicaci√≥n v√°lida

**Errores**:
- "No encontramos esta direcci√≥n en el mapa. Verifica los datos ingresados o ajusta manualmente el pin"
- "Esta direcci√≥n est√° fuera de nuestra zona de cobertura. Por ahora solo entregamos en [zonas]"
- "Encontramos varias ubicaciones similares. Ajusta el pin a la ubicaci√≥n correcta"
- "No pudimos cargar el mapa. Puedes continuar sin validaci√≥n visual" + [Continuar sin mapa]

**Decisi√≥n**: ¬øUbicaci√≥n correcta? ‚Üí S√≠: Paso 5 | No: Ajustar pin o volver

---

### üìç Paso 5: Revisi√≥n Final

**Elementos**:
- Panel dividido (solo en edici√≥n):
  - Izquierda: "Direcci√≥n anterior" (gris)
  - Derecha: "Direcci√≥n nueva" (blanco)
  - Campos cambiados en amarillo
- Direcci√≥n completa formateada
- Miniatura del mapa
- Badge "Predeterminada" si aplica
- [Confirmar y guardar] [Editar] [Cancelar]

**Validaciones**:
- Campos obligatorios completos
- No modificaci√≥n concurrente
- Sesi√≥n activa

**Errores**:
- "Alguien m√°s modific√≥ esta direcci√≥n mientras editabas. Por favor revisa los cambios actuales" + [Sobrescribir] [Cancelar]
- "Algunos datos no son v√°lidos. Por favor revisa: [campos]"
- "Tu sesi√≥n expir√≥. Inicia sesi√≥n nuevamente. Tus cambios se guardar√°n temporalmente"

**Decisi√≥n**: Confirmar ‚Üí Paso 6 | Editar ‚Üí Paso 3 | Cancelar ‚Üí Lista

---

### üìç Paso 6: Confirmaci√≥n Exitosa

**Elementos**:
- ‚úì verde animado
- "¬°Direcci√≥n actualizada exitosamente!"
- "Ahora tus pedidos se enviar√°n a: [direcci√≥n]"
- Timestamp
- Panel de direcci√≥n guardada
- Mensaje si es predeterminada
- Acciones r√°pidas:
  - [Ver todas mis direcciones]
  - [Agregar otra]
  - [Actualizar pago]
  - [Continuar comprando]
- Notificaci√≥n: Email enviado

**Validaciones**:
- Escritura en BD confirmada
- Email enviado
- Log de auditor√≠a

**Errores**:
- "Tu direcci√≥n se guard√≥ correctamente, pero no pudimos enviar el email de confirmaci√≥n"
- "‚ÑπÔ∏è Tienes 2 pedidos en camino a tu direcci√≥n anterior. Este cambio aplicar√° solo para nuevos pedidos"

**Comportamiento adicional**:
- Auto-redirecci√≥n en 10s (con contador)
- Si desde checkout: "¬øDeseas usar esta direcci√≥n para tu pedido actual?"

---

## üßæ OPCI√ìN C: Generaci√≥n de Factura de Compra

### Resumen del Flujo

**Objetivo**: Generar factura electr√≥nica (CFDI 4.0) cumpliendo normativa SAT de M√©xico.

**Pasos**: 6  
**Tiempo estimado**: 4-7 minutos  
**Complejidad**: Alta

---

### üìç Paso 1: Selecci√≥n de Compra

**Elementos**:
- Breadcrumb: Mi cuenta > Pedidos > Solicitar factura
- Filtros:
  - Rango fechas (7/30/90 d√≠as, personalizado)
  - Estado (Facturables/Facturados/Expirados)
  - Monto (asc/desc)
  - M√©todo de pago
- Lista de pedidos:
  - N√∫mero: #PED-YYYYMMDD-####
  - Fecha: "Comprado el DD de MMM, YYYY"
  - Productos: "iPhone 15 + 2 m√°s" + [Ver detalle]
  - Monto: $XXX.XX MXN (IVA incluido)
  - Badge: Pendiente/Facturado/No facturable
  - [Facturar] (habilitado/deshabilitado)
  - Fecha l√≠mite: "Hasta: [fecha]" (rojo si <3 d√≠as)

**Validaciones**:
- Pedido completado/entregado
- Dentro de 30 d√≠as (M√©xico)
- No facturado previamente
- Monto > 0

**Errores**:
- "Ya facturado el [fecha]" + [Descargar existente]
- "El plazo para facturar expir√≥ el [fecha]. Por ley solo podemos facturar compras de los √∫ltimos 30 d√≠as"
- "Este pedido fue cancelado y no es facturable"
- "No tienes compras pendientes de facturar"
- "No pudimos cargar tu historial" + [Reintentar]

**Decisi√≥n**: ¬øTiene datos fiscales? ‚Üí S√≠: Pre-llena Paso 3 | No: Paso 2

---

### üìç Paso 2: Datos Fiscales

**Sin datos previos**:
- RFC * (XXXX######XXX o XXXX######XX#)
  - Validador tiempo real con SAT
  - [¬øNo sabes tu RFC?] ‚Üí consulta SAT
- Tipo de persona * (F√≠sica/Moral)
- Raz√≥n Social / Nombre * (auto-completa si RFC v√°lido)
- R√©gimen Fiscal * (dropdown filtrado por tipo)
  - Formato: "601 - General de Ley Personas Morales"
- CP Fiscal * (5 d√≠gitos)
- Email factura * (pre-llena cuenta)
- [Checkbox] Guardar para futuras facturas

**Con datos existentes**:
- Lista de perfiles (m√°x 5):
  - RFC (parcialmente oculto)
  - Raz√≥n Social
  - R√©gimen
  - Badge "Predeterminado"
  - [Seleccionar]
- [+ Agregar nuevo perfil]

**Validaciones**:
- RFC: formato + checksum
- Validaci√≥n SAT (si disponible)
- Email: formato v√°lido
- CP: 5 d√≠gitos en cat√°logo SAT
- R√©gimen compatible con tipo persona
- Raz√≥n Social: m√≠n 3 caracteres

**Errores**:
- "El RFC ingresado no tiene un formato v√°lido. Verifica e intenta nuevamente"
- "Este RFC no existe en el padr√≥n del SAT. Verifica tu RFC" + [Consultar SAT]
- "Este RFC no est√° activo ante el SAT. No podemos emitir facturas con este RFC"
- "No pudimos validar tu RFC con el SAT. Podemos continuar, pero verifica que tu RFC sea correcto"
- "Este r√©gimen fiscal no es v√°lido para Persona F√≠sica. Selecciona uno diferente"
- "Has alcanzado el l√≠mite de 5 perfiles fiscales. Elimina uno para agregar otro"

**Decisi√≥n**: ¬øV√°lido? ‚Üí S√≠: Paso 3 | No: Corregir

---

### üìç Paso 3: Uso de CFDI

**Elementos**:
- T√≠tulo: "Selecciona el uso que le dar√°s a esta factura"
- ‚ÑπÔ∏è "El uso de CFDI es requerido por el SAT y debe coincidir con la naturaleza de tu compra"
- Dropdown con b√∫squeda:
  - Lista completa cat√°logo SAT
  - Formato: C√≥digo + Descripci√≥n
  - Comunes destacados:
    - G01 - Adquisici√≥n de mercanc√≠as
    - G03 - Gastos en general
    - I04 - Equipo de c√≥mputo
    - D01 - Honorarios m√©dicos
    - P01 - Por definir
- Buscador: "Escribe para buscar..."
- [¬øNo sabes cu√°l elegir?] ‚Üí Modal:
  - Explicaci√≥n usos comunes
  - Recomendaci√≥n seg√∫n productos
  - "Consulta con tu contador"
  - [Ver cat√°logo SAT]

**Validaciones**:
- Selecci√≥n obligatoria
- C√≥digo vigente en cat√°logo
- Compatible con tipo persona

**Errores**:
- "Debes seleccionar el uso de CFDI para continuar"
- "Este uso de CFDI no es compatible con tu tipo de persona"
- "Este uso de CFDI ya no est√° vigente. Selecciona uno actualizado"
- "No pudimos cargar el cat√°logo de usos de CFDI" + [Reintentar]

**Funcionalidad inteligente**:
- Sugerencia basada en productos
- Advertencia P01: "‚ö†Ô∏è P01 no permite deducciones fiscales. ¬øEst√°s seguro?"

**Decisi√≥n**: ¬øApropiado? ‚Üí S√≠: Paso 4 | Incierto: Ayuda

---

### üìç Paso 4: Revisi√≥n y Desglose

**Secciones**:

**1. Datos Fiscales** (editable):
- RFC, Raz√≥n Social, R√©gimen, Uso CFDI, CP, Email
- [‚úèÔ∏è Editar] ‚Üí regresa Paso 2

**2. Datos del Pedido**:
- N√∫mero, Fecha, M√©todo pago

**3. Desglose de Productos** (tabla):
| Cant | Descripci√≥n (SKU) | Precio Unit | Subtotal |
|------|-------------------|-------------|----------|
| 1 | iPhone 15 Pro (IP15P) | $20,000.00 | $20,000.00 |

**4. Resumen Financiero**:
- Subtotal: $XX,XXX.XX
- Descuentos: -$XXX.XX
- Subtotal final: $XX,XXX.XX
- **IVA (16%)**: $X,XXX.XX
- IEPS (si aplica): $XXX.XX
- **Total**: $XX,XXX.XX MXN
- Cantidad en letra

**5. Informaci√≥n Legal**:
- Forma de pago (cat√°logo SAT)
- M√©todo: PUE/PPD
- Tipo: I - Ingreso
- Moneda: MXN

**Elementos adicionales**:
- [Vista previa PDF] (temporal, sin timbre)
- [Checkbox obligatorio] "He revisado y confirmo que todos los datos son correctos"
- ‚ö†Ô∏è "Una vez generada, NO se podr√° modificar ni cancelar durante 24 horas"
- [Generar factura] (deshabilitado hasta checkbox)
- [Editar datos] [Cancelar]

**Validaciones**:
- Integridad datos fiscales
- C√°lculo impuestos correcto
- Total coincide con pedido

**Errores**:
- "Detectamos una inconsistencia en los montos. Por favor contacta a soporte"
- "Algunos productos no son facturables: [lista]. Solo se facturar√°n los v√°lidos" + checkbox aceptar
- "Falta informaci√≥n requerida. Por favor completa tus datos fiscales"

**Decisi√≥n**: ¬øCorrecto? ‚Üí S√≠: Paso 5 | No: Editar

---

### üìç Paso 5: Timbrado

**Elementos**:
- Indicador de progreso:
  1. ‚úì Validando datos fiscales...
  2. ‚ü≥ Generando XML de factura...
  3. ‚è∏ Conectando con el SAT...
  4. ‚è∏ Timbrando factura...
  5. ‚è∏ Generando PDF...
- Barra: [=========>........] 45%
- "Esto puede tomar hasta 30 segundos. No cierres esta ventana"
- Spinner animado
- Info t√©cnica (colapsable):
  - UUID: En espera...
  - Serie y folio: Asignando...
  - Fecha timbrado: Pendiente...

**Validaciones backend**:
- Certificados vigentes (CSD)
- Conexi√≥n PAC exitosa
- XML v√°lido SAT
- UUID √∫nico
- Sello digital aplicado

**Errores cr√≠ticos**:

**SAT no disponible**:
- "‚ùå El servicio del SAT no est√° disponible temporalmente. Esto es com√∫n en fines de semana o d√≠as festivos"
- "Intenta nuevamente en unos minutos o espera a d√≠a h√°bil"
- [Reintentar] [Notificarme]
- Guardar en cola para procesamiento autom√°tico

**RFC bloqueado**:
- "‚ùå El RFC est√° en el listado de contribuyentes no localizados o con certificados revocados del SAT"
- "No podemos emitir factura con este RFC. Regulariza tu situaci√≥n fiscal"
- [Usar otro RFC] ‚Üí Paso 2

**Certificados vencidos**:
- "‚ùå Nuestros certificados digitales est√°n actualiz√°ndose. Intenta en 10 minutos"
- [Notificarme por email]

**XML rechazado**:
- "‚ùå El SAT rechaz√≥ la factura. C√≥digo de error: [c√≥digo]"
- Detalle t√©cnico + explicaci√≥n
- [Reintentar con datos corregidos] [Contactar soporte]

**Timeout**:
- "‚è±Ô∏è La petici√≥n tard√≥ demasiado. El proceso puede haber sido exitoso"
- "Verificando estado..."
- Si existe ‚Üí Paso 6 | No existe ‚Üí Reintentar

**Manejo de errores**:
- Guardar solicitud para auditor√≠a
- Email con detalles y pasos
- Bloqueo de pedido (no doble facturaci√≥n)
- [Hablar con soporte] ‚Üí chat/ticket

**Decisi√≥n**: ¬øTimbrado exitoso? ‚Üí S√≠: Paso 6 | No: Error espec√≠fico

---

### üìç Paso 6: Descarga

**Elementos**:

**Mensaje de √©xito**:
- ‚úì grande verde
- "¬°Tu factura ha sido generada exitosamente!"
- "El XML y PDF se enviaron a tu correo electr√≥nico"

**Panel de informaci√≥n**:
- **UUID**: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX [üìã Copiar]
  - "Este es tu folio fiscal √∫nico. Gu√°rdalo para cualquier aclaraci√≥n"
- Serie y Folio: A-12345
- Fecha emisi√≥n: DD de MMM, YYYY - HH:MM:SS
- Fecha timbrado: DD de MMM, YYYY - HH:MM:SS
- Sello SAT: ABC...XYZ
- **Monto total**: $XX,XXX.XX MXN

**Descarga**:
- üìÑ [Descargar PDF] (principal)
  - Archivo: Factura_[RFC]_[UUID].pdf
- üìã [Descargar XML] (secundario)
  - Archivo: Factura_[RFC]_[UUID].xml
- üì¶ [Descargar ambos (.zip)] (terciario)
- Contador: "Archivos descargados: 0/2"
- Vista previa PDF (opcional)

**Opciones adicionales**:
- üìß Reenviar por email:
  - Campo email + [Reenviar]
  - "Correo reenviado a [email]"
- üîó Enlace de descarga:
  - URL temporal (7 d√≠as)
  - [üìã Copiar enlace]
  - "Este enlace expira el [fecha]"
- ‚úÖ Verificar en SAT:
  - Link: https://verificacfdi.facturaelectronica.sat.gob.mx/
  - Instrucciones breves

**Informaci√≥n colapsable**:
- Emisor
- Receptor
- Desglose productos
- Totales e impuestos
- M√©todo y forma de pago

**Ayuda (FAQ)**:
- "¬øC√≥mo verifico mi factura en el SAT?"
- "¬øPuedo cancelar esta factura?"
- "¬øQu√© hago si hay un error?"
- "¬øC√≥mo hago una aclaraci√≥n?"
- Pol√≠ticas de cancelaci√≥n:
  - No cancelable en 24h
  - Despu√©s: solicitar (requiere aceptaci√≥n si monto alto)

**Navegaci√≥n**:
- [Ir a mis facturas]
- [Facturar otro pedido]
- [Volver a pedidos]
- [Continuar comprando]

**Validaciones post**:
- Email enviado (estado: enviado/pendiente/error)
- PDF y XML generados
- Registro en BD

**Errores post-generaci√≥n**:
- "La factura se timbr√≥ exitosamente, pero hubo un problema al generar el PDF. Puedes descargarlo m√°s tarde desde 'Mis Facturas'"
- "Tu factura se gener√≥, pero no pudimos enviar el email. Puedes descargar los archivos aqu√≠"

**Autom√°tico**:
- Email con:
  - PDF y XML adjuntos (o enlaces)
  - UUID y datos principales
  - Enlaces descarga alternativos
  - Instrucciones verificaci√≥n SAT
- Registro en historial
- Marca pedido "Facturado"
- Notificaci√≥n push (si app): "Tu factura est√° lista"

**Legal**:
- "Esta factura es un CFDI conforme a la legislaci√≥n del SAT"
- "Conserva el XML para efectos fiscales"
- [Aviso de privacidad]

**Estad√≠sticas (opcional)**:
- "Has generado X facturas este a√±o por $XXX,XXX.XX"
- "Pr√≥xima factura disponible: [folio]"

---

## üìä Matriz de Validaciones

### Validaciones Comunes

| Campo | Tipo | Regla | Mensaje Error |
|-------|------|-------|---------------|
| Email | String | Formato @dominio | "Ingresa un email v√°lido" |
| Tel√©fono | String | 10 d√≠gitos | "Ingresa un tel√©fono v√°lido de 10 d√≠gitos" |
| C√≥digo Postal | String | 5 d√≠gitos | "El c√≥digo postal debe tener 5 d√≠gitos" |
| Texto largo | String | 10-500 chars | "M√≠nimo 10 caracteres" / "M√°ximo 500 caracteres" |
| RFC | String | Formato XXXX######XXX | "El RFC ingresado no tiene un formato v√°lido" |

---

## üé® Patrones de Dise√±o Aplicados

### Validaci√≥n Progresiva

**Principio**: Validar en m√∫ltiples niveles para mejor UX.

**Niveles**:
1. **Cliente (JavaScript)**: Formato b√°sico, longitud
2. **Visual**: Resaltado en tiempo real
3. **Servidor**: Validaci√≥n contra BD/APIs
4. **Negocio**: Reglas complejas post-submit

**Ejemplo Implementaci√≥n**:
```javascript
// Nivel 1: Cliente
input.addEventListener('blur', (e) => {
  if (!validateEmail(e.target.value)) {
    showError('Formato de email inv√°lido');
  }
});

// Nivel 2: Visual
input.addEventListener('input', (e) => {
  if (e.target.value.includes('@')) {
    input.classList.add('valid');
  }
});

// Nivel 3: Servidor
async function submitForm() {
  const response = await api.post('/validate', formData);
  if (!response.valid) {
    showErrors(response.errors);
  }
}
```

---

### Retroalimentaci√≥n Contextual

**Principio**: Mensajes espec√≠ficos, no gen√©ricos.

**Mal ejemplo**: ‚ùå "Error en el formulario"

**Buen ejemplo**: ‚úÖ "El RFC ingresado no tiene un formato v√°lido. Debe ser de 13 caracteres (Ej: GOMJ850212XXX)"

**Componentes**:
- üéØ **Espec√≠fico**: Qu√© est√° mal
- üí° **Accionable**: C√≥mo solucionarlo
- üìò **Educativo**: Por qu√© es importante

---

### Manejo de Estados

**Estados posibles**:
```
IDLE ‚Üí LOADING ‚Üí SUCCESS
  ‚Üì        ‚Üì         ‚Üì
ERROR ‚Üê TIMEOUT ‚Üê RETRY
```

**Implementaci√≥n visual**:
| Estado | Color | √çcono | Mensaje |
|--------|-------|-------|---------|
| Idle | Gris | - | Campo vac√≠o |
| Valid | Verde | ‚úì | "Correcto" |
| Invalid | Rojo | ‚úó | Mensaje espec√≠fico |
| Warning | Amarillo | ‚ö†Ô∏è | "Verifica esto" |
| Loading | Azul | ‚ü≥ | "Validando..." |

---

### Prevenci√≥n de Errores

**Mejor que manejar errores: prevenirlos**

**T√©cnicas aplicadas**:

1. **Deshabilitar opciones no v√°lidas**
   - Fechas pasadas en calendario
   - Especialidades sin disponibilidad
   - Botones hasta completar campos

2. **Auto-completado inteligente**
   - CP ‚Üí auto-llena Estado/Municipio
   - RFC ‚Üí sugiere Raz√≥n Social
   - B√∫squeda ‚Üí sugerencias similares

3. **L√≠mites visuales**
   - Contador de caracteres
   - Barra de progreso
   - Temporizador de bloqueo

4. **Validaci√≥n en tiempo real**
   - Formato de email mientras escribe
   - Disponibilidad de horarios
   - Conflictos de datos

---

### Recuperaci√≥n de Errores

**Cuando ocurre un error, ofrecer salidas claras**

**Patr√≥n aplicado**:
```
ERROR detectado
  ‚Üì
Mostrar mensaje espec√≠fico
  ‚Üì
Ofrecer 2-3 opciones:
  1. Reintentar
  2. Alternativa
  3. Contactar soporte
```

**Ejemplo**:
```
‚ùå "Este horario acaba de ser reservado"
  ‚Üí [Elegir otro horario]
  ‚Üí [Volver al calendario]
  ‚Üí [Hablar con soporte]
```

---

## üîê Consideraciones de Seguridad

### Autenticaci√≥n y Sesi√≥n

**Medidas implementadas**:
- ‚úÖ L√≠mite de 3 intentos fallidos
- ‚úÖ Bloqueo temporal (15 min)
- ‚úÖ Tokens de sesi√≥n con expiraci√≥n
- ‚úÖ Validaci√≥n de sesi√≥n en cada paso cr√≠tico
- ‚úÖ HTTPS obligatorio (impl√≠cito)

### Sanitizaci√≥n de Datos

**Inputs que requieren sanitizaci√≥n**:
```javascript
// Motivo de consulta
function sanitize(input) {
  return input
    .replace(/[<>{}]/g, '')  // Eliminar caracteres peligrosos
    .trim()
    .substring(0, 500);      // Limitar longitud
}

// RFC
function sanitizeRFC(rfc) {
  return rfc
    .toUpperCase()
    .replace(/[^A-Z0-9]/g, '')
    .substring(0, 13);
}
```

### Validaci√≥n de Datos Fiscales

**Verificaciones contra SAT**:
1. RFC existe en padr√≥n
2. RFC est√° activo
3. No en lista negra (contribuyentes no localizados)
4. Certificados vigentes

---

## üì± Responsive Design

### Breakpoints Recomendados

```css
/* Mobile First */
.container { width: 100%; }

/* Tablet */
@media (min-width: 768px) {
  .container { width: 750px; }
}

/* Desktop */
@media (min-width: 1024px) {
  .container { width: 970px; }
}

/* Large Desktop */
@media (min-width: 1280px) {
  .container { width: 1170px; }
}
```

### Adaptaciones por Dispositivo

**Mobile**:
- Formularios de 1 columna
- Botones de altura t√°ctil (44px min)
- Men√∫s colapsables
- Inputs con teclado apropiado (numeric, email, tel)

**Tablet**:
- Formularios de 2 columnas
- Sidebar visible
- Calendario m√°s espaciado

**Desktop**:
- Todos los controles visibles
- Tooltips en hover
- Atajos de teclado

---

## üåê Internacionalizaci√≥n (i18n)

### Preparaci√≥n para M√∫ltiples Idiomas

**Estructura recomendada**:
```javascript
const messages = {
  es: {
    login: {
      title: "Iniciar sesi√≥n",
      email: "Correo electr√≥nico",
      password: "Contrase√±a",
      submit: "Entrar"
    },
    errors: {
      required: "Este campo es obligatorio",
      invalidEmail: "Ingresa un email v√°lido"
    }
  },
  en: {
    login: {
      title: "Log in",
      email: "Email address",
      password: "Password",
      submit: "Sign in"
    },
    errors: {
      required: "This field is required",
      invalidEmail: "Please enter a valid email"
    }
  }
};
```

### Formato de Fechas y Monedas

**Fechas**:
- Espa√±a: DD/MM/YYYY
- M√©xico: DD de MMM, YYYY
- USA: MM/DD/YYYY

**Moneda**:
- M√©xico: $1,234.56 MXN
- USA: $1,234.56 USD
- Europa: ‚Ç¨1.234,56 EUR

---

## ‚ôø Accesibilidad (WCAG 2.1)

### Principios Aplicados

**1. Perceptible**
- ‚úÖ Contraste m√≠nimo 4.5:1
- ‚úÖ Texto alternativo en im√°genes
- ‚úÖ Etiquetas en todos los campos

**2. Operable**
- ‚úÖ Navegaci√≥n por teclado (Tab)
- ‚úÖ √Årea t√°ctil m√≠nima 44x44px
- ‚úÖ Sin l√≠mites de tiempo restrictivos (excepto seguridad)

**3. Comprensible**
- ‚úÖ Mensajes de error claros
- ‚úÖ Instrucciones visibles
- ‚úÖ Navegaci√≥n consistente

**4. Robusto**
- ‚úÖ HTML sem√°ntico
- ‚úÖ ARIA labels donde necesario
- ‚úÖ Compatible con lectores de pantalla

### Atributos ARIA Recomendados

```html
<!-- Campo con error -->
<input 
  type="email" 
  id="email"
  aria-label="Correo electr√≥nico"
  aria-describedby="email-error"
  aria-invalid="true"
  required
/>
<span id="email-error" role="alert">
  Ingresa un email v√°lido
</span>

<!-- Bot√≥n con estado de carga -->
<button 
  type="submit"
  aria-busy="true"
  aria-label="Generando factura, por favor espera">
  <span class="spinner"></span>
  Generando...
</button>

<!-- Secci√≥n colapsable -->
<button 
  aria-expanded="false"
  aria-controls="faq-content">
  Preguntas frecuentes
</button>
<div id="faq-content" hidden>
  ...
</div>
```

---

## üß™ Testing y Quality Assurance

### Casos de Prueba Cr√≠ticos

#### Opci√≥n A: Citas M√©dicas

| Test ID | Descripci√≥n | Pasos | Resultado Esperado |
|---------|-------------|-------|-------------------|
| A-001 | Login exitoso | 1. Ingresar credenciales v√°lidas<br>2. Click "Iniciar sesi√≥n" | Redirige a dashboard |
| A-002 | Login fallido 3x | 1. Ingresar 3 veces credenciales incorrectas | Cuenta bloqueada 15 min |
| A-003 | Selecci√≥n de especialidad sin disponibilidad | 1. Click en especialidad gris | Mensaje "Sin citas disponibles" + opci√≥n lista de espera |
| A-004 | Bloqueo temporal de horario | 1. Seleccionar horario<br>2. Esperar 5 min sin completar | Horario se libera autom√°ticamente |
| A-005 | Detecci√≥n de emergencia | 1. Escribir "infarto" en motivo | Banner amarillo con opci√≥n llamar 911 |

#### Opci√≥n B: Direcciones

| Test ID | Descripci√≥n | Pasos | Resultado Esperado |
|---------|-------------|-------|-------------------|
| B-001 | Auto-completado por CP | 1. Ingresar CP v√°lido (76000) | Estado/Municipio se auto-llenan |
| B-002 | CP sin cobertura | 1. Ingresar CP fuera de zona | Mensaje "Sin cobertura en este CP" |
| B-003 | Geolocalizaci√≥n GPS | 1. Click "Usar ubicaci√≥n actual" | Campos se auto-llenan con ubicaci√≥n |
| B-004 | Eliminar direcci√≥n predeterminada | 1. Click "Eliminar" en predeterminada | Mensaje "No puedes eliminar predeterminada" |
| B-005 | L√≠mite 10 direcciones | 1. Intentar agregar 11¬™ direcci√≥n | Mensaje "Has alcanzado el l√≠mite de 10" |

#### Opci√≥n C: Facturas

| Test ID | Descripci√≥n | Pasos | Resultado Esperado |
|---------|-------------|-------|-------------------|
| C-001 | RFC v√°lido | 1. Ingresar RFC formato correcto | Validaci√≥n verde + auto-completa datos |
| C-002 | RFC bloqueado | 1. Ingresar RFC en lista negra SAT | Error "RFC no activo ante el SAT" |
| C-003 | Selecci√≥n uso CFDI | 1. Seleccionar P01 | Advertencia "No permite deducciones" |
| C-004 | Timbrado exitoso | 1. Completar todos los pasos<br>2. Click "Generar" | Factura timbrada + UUID generado |
| C-005 | SAT no disponible | 1. Generar factura cuando SAT ca√≠do | Mensaje "SAT temporalmente no disponible" + opci√≥n notificar |

---

## üìà M√©tricas de √âxito

### KPIs por Flujo

**Opci√≥n A - Citas**:
- Tasa de completaci√≥n: >85%
- Tiempo promedio: <4 minutos
- Errores de validaci√≥n: <2 por sesi√≥n
- Abandono en paso 4: <10%

**Opci√≥n B - Direcciones**:
- Uso de GPS: >60%
- Direcciones con error de geolocalizaci√≥n: <5%
- Ediciones post-guardado: <15%

**Opci√≥n C - Facturas**:
- Facturas generadas primer intento: >90%
- Tiempo de timbrado: <30 segundos
- Errores de RFC: <8%
- Descargas de XML+PDF: >95%

---

## üîÑ Flujos Alternativos

### Usuarios No Registrados

**Opci√≥n A**:
```
Landing ‚Üí [Solicitar cita]
  ‚Üì
¬øRegistrado?
  ‚îú‚îÄ NO ‚Üí Registro r√°pido (email + password)
  ‚îî‚îÄ S√ç ‚Üí Login ‚Üí Flujo normal
```

**Opci√≥n B**:
```
Checkout ‚Üí [Agregar direcci√≥n]
  ‚Üì
¬øRegistrado?
  ‚îú‚îÄ NO ‚Üí Guest checkout (direcci√≥n sin guardar)
  ‚îî‚îÄ S√ç ‚Üí Flujo normal con guardado
```

---

## üõ†Ô∏è Stack Tecnol√≥gico Recomendado

### Frontend
- **HTML5**: Estructura sem√°ntica
- **CSS3 / Tailwind CSS**: Estilos utility-first
- **JavaScript (ES6+)**: L√≥gica de negocio
- **React / Vue** (opcional): Para apps complejas

### Backend
- **Node.js / Python**: API REST
- **PostgreSQL / MySQL**: Base de datos
- **Redis**: Cache y bloqueos temporales
- **WebSocket**: Actualizaci√≥n real-time

### Integraciones
- **Google Maps API**: Geolocalizaci√≥n
- **SAT Web Services**: Validaci√≥n RFC y timbrado
- **SendGrid / Mailgun**: Env√≠o de emails
- **Twilio**: SMS y WhatsApp

### Infraestructura
- **AWS / Azure / GCP**: Hosting
- **CDN**: Assets est√°ticos
- **Load Balancer**: Distribuci√≥n de carga
- **Monitoring**: Sentry, DataDog

---

## üìö Glosario T√©cnico

| T√©rmino | Definici√≥n |
|---------|------------|
| **AJAX** | Asynchronous JavaScript And XML - Peticiones as√≠ncronas sin recargar p√°gina |
| **CFDI** | Comprobante Fiscal Digital por Internet - Factura electr√≥nica en M√©xico |
| **CSD** | Certificado de Sello Digital - Firma electr√≥nica para facturaci√≥n |
| **Geolocalizaci√≥n** | Determinar ubicaci√≥n geogr√°fica mediante coordenadas GPS |
| **PAC** | Proveedor Autorizado de Certificaci√≥n - Intermediario para timbrado SAT |
| **RFC** | Registro Federal de Contribuyentes - Identificador fiscal en M√©xico |
| **SAT** | Servicio de Administraci√≥n Tributaria - Autoridad fiscal de M√©xico |
| **UUID** | Universally Unique IDentifier - Folio fiscal √∫nico de 36 caracteres |
| **Validaci√≥n en tiempo real** | Verificaci√≥n de datos mientras el usuario escribe |
| **Wireframe** | Prototipo de baja fidelidad que muestra estructura sin dise√±o final |

---

## üîó Referencias y Recursos

### Documentaci√≥n Oficial

**M√©xico - SAT**:
- [Portal SAT](https://www.sat.gob.mx/)
- [Cat√°logo CFDI 4.0](http://omawww.sat.gob.mx/tramitesyservicios/Paginas/documentos/Catalogo_CFDI.xls)
- [Consulta RFC](https://www.sat.gob.mx/aplicacion/31274/consulta-tu-clave-de-rfc-mediante-curp)
- [Verificaci√≥n de CFDI](https://verificacfdi.facturaelectronica.sat.gob.mx/)

**UX/UI Best Practices**:
- [Nielsen Norman Group](https://www.nngroup.com/)
- [Material Design Guidelines](https://material.io/design)
- [Apple Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)

**Accesibilidad**:
- [WCAG 2.1](https://www.w3.org/WAI/WCAG21/quickref/)
- [WebAIM](https://webaim.org/)
- [A11y Project](https://www.a11yproject.com/)

---

## üìù Notas Finales

### Mantenimiento del Documento

Este documento debe actualizarse cuando:
- ‚úÖ Se agreguen nuevos pasos o flujos
- ‚úÖ Cambien validaciones o reglas de negocio
- ‚úÖ Se modifiquen mensajes de error
- ‚úÖ Actualicen regulaciones (ej: cat√°logo SAT)

### Versionado

- **v1.0.0** (2025-12-24): Versi√≥n inicial con 3 flujos completos
- **v1.1.0** (Pendiente): Agregar flujos de pago y checkout
- **v2.0.0** (Futuro): Integraci√≥n con app m√≥vil

---

<div align="center">

**Documentaci√≥n creada para el proyecto:**  
**[ux-wireframes-interactive](https://github.com/BENMP0902/ux-wireframes-interactive)**

√öltima actualizaci√≥n: Diciembre 24, 2025

</div>